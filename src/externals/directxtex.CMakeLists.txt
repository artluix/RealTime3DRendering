cmake_minimum_required(VERSION 3.2 FATAL_ERROR)

# directxtex (needed for application & tools)
project(directxtex)

set(DIRECTXTEX_SOURCES
    # sources
    directxtex/BC.h
    directxtex/BC.cpp
    directxtex/BC4BC5.cpp
    directxtex/BC6HBC7.cpp
    directxtex/BCDirectCompute.h
    directxtex/DDS.h
    directxtex/filters.h
    directxtex/scoped.h
    directxtex/DirectXTex.h
    directxtex/DirectXTexP.h
    directxtex/DirectXTex.inl
    directxtex/BCDirectCompute.cpp
    directxtex/DirectXTexCompress.cpp
    directxtex/DirectXTexCompressGPU.cpp
    directxtex/DirectXTexConvert.cpp
    directxtex/DirectXTexD3D11.cpp
    directxtex/DirectXTexDDS.cpp
    directxtex/DirectXTexFlipRotate.cpp
    directxtex/DirectXTexHDR.cpp
    directxtex/DirectXTexImage.cpp
    directxtex/DirectXTexMipMaps.cpp
    directxtex/DirectXTexMisc.cpp
    directxtex/DirectXTexNormalMaps.cpp
    directxtex/DirectXTexPMAlpha.cpp
    directxtex/DirectXTexResize.cpp
    directxtex/DirectXTexTGA.cpp
    directxtex/DirectXTexUtil.cpp
    directxtex/DirectXTexWIC.cpp

    # shaders
    directxtex/Shaders/BC6HEncode.hlsl
    directxtex/Shaders/BC7Encode.hlsl

    # shaders (compiled)
    directxtex/Shaders/Compiled/BC6HEncode_EncodeBlockCS.inc
    directxtex/Shaders/Compiled/BC6HEncode_EncodeBlockCS.pdb
    directxtex/Shaders/Compiled/BC6HEncode_TryModeG10CS.inc
    directxtex/Shaders/Compiled/BC6HEncode_TryModeG10CS.pdb
    directxtex/Shaders/Compiled/BC6HEncode_TryModeLE10CS.inc
    directxtex/Shaders/Compiled/BC6HEncode_TryModeLE10CS.pdb
    directxtex/Shaders/Compiled/BC7Encode_EncodeBlockCS.inc
    directxtex/Shaders/Compiled/BC7Encode_EncodeBlockCS.pdb
    directxtex/Shaders/Compiled/BC7Encode_TryMode02CS.inc
    directxtex/Shaders/Compiled/BC7Encode_TryMode02CS.pdb
    directxtex/Shaders/Compiled/BC7Encode_TryMode137CS.inc
    directxtex/Shaders/Compiled/BC7Encode_TryMode137CS.pdb
    directxtex/Shaders/Compiled/BC7Encode_TryMode456CS.inc
    directxtex/Shaders/Compiled/BC7Encode_TryMode456CS.pdb
    # directxtex/Shaders/CompileShaders.cmd
)

add_library(directxtex STATIC ${DIRECTXTEX_SOURCES})

target_include_directories(directxtex
    PUBLIC
        $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}>
    PRIVATE
        directxtex
        .
)

target_compile_options(directxtex
    PRIVATE
        /W3
        /fp:fast
        /openmp
        /arch:SSE2

        # /permissive-
        /YuDirectXTexP.h
        /sdl

        /MP

        # debug
        $<$<CONFIG:DEBUG>: /Od>

        # release
        $<$<CONFIG:RELEASE>: /MD /O2 /Gy /Oi>
)

target_compile_definitions(directxtex
    PUBLIC
        -DUNICODE
        -D_UNICODE
        -D_WIN32_WINNT=0x0600
        -D_WIN7_PLATFORM_UPDATE
        -DWIN32
        -D_CRT_STDIO_ARBITRARY_WIDE_SPECIFIERS
        -D_LIB
)

# avoid compilation of shaders (enabled by default)
set_source_files_properties(directxtex/Shaders/BC6HEncode.hlsl PROPERTIES VS_TOOL_OVERRIDE "None")
set_source_files_properties(directxtex/Shaders/BC7Encode.hlsl PROPERTIES VS_TOOL_OVERRIDE "None")

set_source_files_properties(directxtex/DirectXTexUtil.cpp PROPERTIES COMPILE_FLAGS /YcDirectXTexP.h)

# ide filters
source_group(TREE ${CMAKE_CURRENT_SOURCE_DIR} FILES ${DIRECTXTEX_SOURCES})

if(TOOLS)

    # ddsview
    project(ddsview)

    set(DDSVIEW_SOURCES
        DDSView/ddsview.cpp
        DDSView/DDSView.rc
        DDSView/ddsview.fx
    )

    add_executable(ddsview WIN32 ${DDSVIEW_SOURCES})

    target_include_directories(ddsview
        PRIVATE
            $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/DirectXTex>
    )

    target_compile_options(ddsview
        PRIVATE
            /W4
            /fp:fast
            /arch:SSE2

            /guard:cf
            /sdl

            /MP

            # debug
            $<$<CONFIG:DEBUG>: /Od>

            # release
            $<$<CONFIG:RELEASE>: /MD /O2 /Gy /Oi>
    )

    target_compile_definitions(ddsview
        PUBLIC
            -DUNICODE
            -D_UNICODE
            -D_WIN32_WINNT=0x0600
            -DWIN32
            -DPROFILE
    )

    target_link_libraries(ddsview directxtex d3d11 ole32 windowscodecs uuid)

    set_target_properties(ddsview PROPERTIES DEBUG_POSTFIX ${CMAKE_DEBUG_POSTFIX})
    set_target_properties(ddsview PROPERTIES LINK_FLAGS_DEBUG /DEBUG:FASTLINK)
    set_target_properties(ddsview PROPERTIES LINK_FLAGS_RELEASE /OPT:REF)

    # ide filters
    source_group(TREE ${CMAKE_CURRENT_SOURCE_DIR} FILES ${DDSVIEW_SOURCES})

    # install
    install(TARGETS ddsview
        RUNTIME DESTINATION ${TOOLS_DIR}/bin/ddsview
    )

    # texassemble

    # texconv

    # texdiag

endif()